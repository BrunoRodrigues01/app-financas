name: Build e Upload para TestFlight

on:
  push:
    tags:
      - 'v*'  # Executa quando voc√™ criar uma tag (ex: v1.0.0)
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build-and-deploy-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run tests
      run: flutter test
      continue-on-error: true
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Import Code-Signing Certificates
      uses: Apple-Actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
    
    - name: Download Provisioning Profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
    
    - name: Build iOS Release
      run: |
        flutter build ios --release --no-codesign
        
    - name: Build IPA with Xcode
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -archivePath $PWD/build/Runner.xcarchive \
          -allowProvisioningUpdates \
          archive
        
        xcodebuild -exportArchive \
          -archivePath $PWD/build/Runner.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath $PWD/build \
          -allowProvisioningUpdates
    
    - name: Upload to TestFlight
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file ios/build/Runner.ipa \
          --username "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --team-id "$APPLE_TEAM_ID"
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-testflight-release
        path: ios/build/Runner.ipa
        retention-days: 30
    
    - name: Notify Success
      run: |
        echo "‚úÖ Build conclu√≠do com sucesso!"
        echo "üì± IPA enviado para TestFlight"
        echo "‚è≥ Aguarde processamento no App Store Connect (5-30 min)"
        echo "üîó Acesse: https://appstoreconnect.apple.com"
